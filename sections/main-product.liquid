<section
  id="MainProduct-{{ section.id }}"
  class="pt-1"
  data-section="{{ section.id }}"
>
  <div class="container">
    {%- assign first_3d_model = product.media | where: 'media_type', 'model' | first -%}
    <div class="d-none d-md-block mb-2">
      {% render 'breadcrumbs' %}
    </div>
    <div class="row">
      <div class="col-12 col-md-6">
        <div class="position-relative">
          <div data-product-media>
            {% for media in product.media %}
              <div class="w-100">
                <div>
                  {%- case media.media_type -%}
                  {%- when 'model' -%}
                  {%- assign model_src = media.sources[0] -%}
                    <div class="position-relative border overflow-hidden" style="padding-bottom: {{ 1 | divided_by: first_3d_model.preview_image.aspect_ratio | times: 100 }}%">
                      <model-viewer class="absolute-fill w-100 h-100"
                                    alt="{{ media.alt }}"
                                    src="{{ model_src.url }}"
                                    loading="lazy"
                                    ar ar-modes="webxr scene-viewer quick-look"
                                    poster="{{ media.preview_image | img_url: 'master' }}"
                                    shadow-intensity="1"
                                    camera-controls
                                    touch-action="pan-y"></model-viewer>

                      <div class="product__media__badge position-absolute border rounded-circle">
                        <div class="position-relative" style="padding-bottom: 100%;">
                          <img
                            class="absolute-fill w-100 h-100 fit-contain"
                            src="{{ 'ar-icon.png' | asset_img_url: '120x' }}"
                            sizes="(min-width: 768px) 54px 1x 108px 2x, 30px 1x 60px 2x"
                            loading="lazy"
                            width="30"
                            height="30"
                            alt="AR Icon">
                        </div>
                      </div>
                    </div>
                  {%- when 'image' -%}
                    <div class="position-relative border overflow-hidden" style="padding-bottom: {{ 1 | divided_by: media.aspect_ratio | times: 100 }}%">
                      <img
                        class="absolute-fill fit-cover w-100 h-100"
                        srcset="{%- if media.width >= 165 -%}{{ media | image_url: width: 165 }} 165w,{%- endif -%}
                      {%- if media.width >= 360 -%}{{ media | image_url: width: 360 }} 360w,{%- endif -%}
                      {%- if media.width >= 533 -%}{{ media | image_url: width: 533 }} 533w,{%- endif -%}
                      {%- if media.width >= 720 -%}{{ media | image_url: width: 720 }} 720w,{%- endif -%}
                      {%- if media.width >= 940 -%}{{ media | image_url: width: 940 }} 940w,{%- endif -%}
                      {%- if media.width >= 1066 -%}{{ media | image_url: width: 1066 }} 1066w,{%- endif -%}
                      {{ media | image_url }} {{ media.width }}w"
                        sizes="(min-width: 768px) calc(50vw - 2rem), calc(100vw - 2rem)"
                        loading="lazy"
                        src="{{ media | img_url: '500x' }}"
                        width="{{ media.width }}"
                        height="{{ media.height }}"
                        alt="{{ media.alt }}">
                    </div>
                  {%- endcase -%}
                </div>
              </div>
            {% endfor %}
          </div>

          {% if product.media.size > 1 %}
            <div class="product__media__nav d-flex position-absolute">
              <button class="mr-1 btn--circle border-2 btn--outline btn--outline--dark"
                      data-product-media-nav="prev"
                      aria-controls="Previous slide">
                {% render 'icon' with 'arrow-left' %}
              </button>
              <button class="btn--circle border-2 btn--outline btn--outline--dark"
                      data-product-media-nav="next"
                      aria-controls="Next slide">
                {% render 'icon' with 'arrow-right' %}
              </button>
            </div>
          {% endif %}
        </div>
      </div>
      <div class="col-12 col-md-6">
        <div
          id="ProductInfo-{{ section.id }}"
          class="d-flex flex-column justify-content-start h-100"
        >
          {%- assign product_form_id = 'product-form-' | append: section.id -%}

          {%- for block in section.blocks -%}
            {%- case block.type -%}
            {%- when '@app' -%}
              {% render block %}
            {%- when 'title' -%}
              <div class="mb-1 d-flex align-items-center text-1.125 font-bold text-dark" {{ block.shopify_attributes }}>
                <h1 class="mb-0 text-1.125 font-bold text-dark">{{ product.title | escape }}</h1>
                <span class="ml-0.5 mr-0.5"> - </span>
                <span data-price>
                  {% if settings.currency_code_enabled %}
                    {{ product.selected_or_first_available_variant.price | money_with_currency }}
                  {% else %}
                    {{ product.selected_or_first_available_variant.price | money }}
                  {% endif %}
                </span>
              </div>
            {%- when 'description' -%}
              {%- if product.description != blank -%}
              <div class="mb-1 rte transparent-0.6"  {{ block.shopify_attributes }}>
                {{ product.description }}
              </div>
              {%- endif -%}
            {%- when 'custom_liquid' -%}
              {{ block.settings.custom_liquid }}
            {%- when 'accordion' -%}
               <div class="mb-1" {{ block.shopify_attributes }}>
                 <div class="accordion text-0.875 lh-150" data-accordion>
                   <button class="accordion__button d-flex align-items-center bg-transparent border-none pl-0 pr-0 text-dark text-0.875" id="button_{{ forloop.index }}" aria-expanded="false" aria-controls="content_{{ forloop.index }}"
                           data-accordion-toggle>
                     <span class="accordion__icon border rounded-circle mr-1 position-relative">
                       {% render 'icon' with 'plus', class: 'accordion__icon--plus transition-default absolute-center' %}
                       {% render 'icon' with 'minus', class: 'accordion__icon--minus transition-default absolute-center' %}
                     </span>

                     <span>
                       {{ block.settings.heading }}
                     </span>
                   </button>
                   <div class="accordion__content overflow-hidden" id="content_{{ forloop.index }}" aria-labelledby="button_{{ forloop.index }}"
                        data-accordion-content>
                     <div class="mt-1 rte transparent-0.6">{{ block.settings.content }}</div>
                   </div>
                 </div>
               </div>
            {%- when 'variant_picker' -%}
              <variant-radios
                class="no-js-hidden mt-1 mb-2 mt-md-0"
                data-section="{{ section.id }}"
                data-url="{{ product.url }}"
                {{ block.shopify_attributes }}
              >
                {%- for option in product.options_with_values -%}
                  <fieldset class="js border-none pt-0 pr-0 pb-0 pl-0 mt-0 mr-0 mb-0 ml-0{% unless forloop.last %} mb-2{% endunless %}">
                    <div class="d-flex flex-wrap mb-n1">
                      {%- for value in option.values -%}
                        <input
                          type="radio"
                          id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                          name="{{ option.name }}"
                          value="{{ value | escape }}"
                          form="{{ product_form_id }}"
                          class="visually-hidden"
                          {% if option.selected_value == value %}
                            checked
                          {% endif %}
                        >
                        {% if option.name == 'Color' %}
                          {% assign variant_name = value | handle | replace: '-', '_' %}
                          {% assign icon_name = 'icon-' | append: variant_name | append: '.jpg' %}

                          <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                                 class="option-color d-block {% unless forloop.last %} mr-0.75{% endunless %} mb-1 rounded-circle border transition-default position-relative overflow-hidden">
                            <img srcset="{{ icon_name | asset_img_url: '25x25' }}"
                                 sizes="25px 1x, 50px 2x"
                                 src="{{ icon_name | asset_img_url: '1x1' }}"
                                 loading="lazy"
                                 class="d-block fit-cover"
                                 alt="{{ value }}">
                          </label>
                        {% else %}
                          <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                                 class="btn btn--sm btn--outline{% unless forloop.last %} mr-1{% endunless %} mb-1 font-regular text-0.875 lh-150">
                            {{ value }}
                          </label>
                        {% endif %}
                      {%- endfor -%}
                    </div>
                  </fieldset>
                {%- endfor -%}
                <script type="application/json">
                      {{ product.variants | json }}
                    </script>
              </variant-radios>
            {%- when 'buy_buttons' -%}
              <div class="mt-auto" {{ block.shopify_attributes }}>
                <product-form class="{% if product.selected_or_first_available_variant.available %}product__form {% endif %}d-block z-stack">
                  {%- form 'product', product, id: product_form_id, class: 'form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                    <input
                      type="hidden"
                      name="id"
                      value="{{ product.selected_or_first_available_variant.id }}"
                      disabled
                    >
                    <div>
                      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center mt-1 mt-md-0">
                        <button
                          type="submit"
                          name="add"
                          class="{% if product.selected_or_first_available_variant.available %}btn btn--primary{% else %} pl-0 pr-0 text-primary border-none bg-transparent transparent-0.6{% endif %} product__form__submit font-regular text-uppercase text-1.25 lh-110"
                          {% if product.selected_or_first_available_variant.available == false %}
                            disabled
                          {% endif %}
                        >
                        <span>
                          {%- if product.selected_or_first_available_variant.available -%}
                            {{ 'products.product.add_to_cart' | t }}
                          {%- else -%}
                            {{ 'products.product.sold_out' | t }}
                          {%- endif -%}
                        </span>

                        </button>

                        <div class="{%- if product.selected_or_first_available_variant.available -%}d-none{% endif %}" data-notification>
                          <div class="mt-1 mt-md-0 ml-md-2">
                            <button class="pl-0 pr-0 border-none bg-transparent text-underline transparent-0.6 text-primary klaviyo-bis-trigger">get notified when itâ€™s back in stock</button>
                          </div>
                        </div>
                      </div>
                      {%- if block.settings.show_dynamic_checkout -%}
                        <div class="mt-0.5">
                          {{ form | payment_button }}
                        </div>
                      {%- endif -%}
                    </div>
                  {%- endform -%}
                </product-form>
              </div>
            {%- endcase -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  </div>


  {%- if first_3d_model -%}
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  {%- endif -%}
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'flickity.pkgd.min.js' | asset_url }}"></script>
  <script src="https://unpkg.com/flickity-fade@1/flickity-fade.js"></script>

  <script src="https://a.klaviyo.com/media/js/onsite/onsite.js"></script>
  <script>
      var klaviyo = klaviyo || [];
      klaviyo.init({
          account: "U9irXF",
          platform: "shopify"
      });
      klaviyo.enable("backinstock",{
          trigger: {
              product_page_text: "Notify Me When Available",
              product_page_class: "btn",
              product_page_text_align: "center",
              product_page_margin: "0px",
              replace_anchor: false
          },
          modal: {
              headline: "{{ section.settings.notification_heading }}",
              body_content: "{{ section.settings.notification_content }}",
              email_field_label: "Enter your Email",
              button_label: "{{ section.settings.notification_btn }}",
              subscription_success_label: "You're in! We'll let you know when it's back.",
              footer_content: '',
              drop_background_color: "{{ settings.color_primary | hex_to_rgba: 0.6 }}",
              background_color: "{{ settings.color_light }}",
              text_color: "{{ settings.color_primary }}",
              button_text_color: "{{ settings.color_light }}",
              button_background_color: "{{ settings.color_primary }}",
              close_button_color: "{{ settings.color_primary }}",
              error_background_color: "{{ settings.color_light }}",
              error_text_color: "#C72E2F",
              success_background_color: "{{ settings.color_light }}",
              success_text_color: "#1B9500"
          }
      });
  </script>

  <script>
    new Flickity('[data-product-media]', {
      cellAlign: "left",
      contain: true,
      pageDots: false,
      prevNextButtons: false,
      adaptiveHeight: true,
      wrapAround: true,
      draggable: false,
      fade: true
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function isIE() {
        const ua = window.navigator.userAgent;
        const msie = ua.indexOf('MSIE ');
        const trident = ua.indexOf('Trident/');

        return (msie > 0 || trident > 0);
      }

      if (!isIE()) return;
      const hiddenInput = document.querySelector('#{{ product_form_id }} input[name="id"]');
      const noScriptInputWrapper = document.createElement('div');
      const variantSwitcher = document.querySelector('variant-radios[data-section="{{ section.id }}"]') || document.querySelector('variant-selects[data-section="{{ section.id }}"]');
      noScriptInputWrapper.innerHTML = document.querySelector('.product-form__noscript-wrapper-{{ section.id }}').textContent;
      variantSwitcher.outerHTML = noScriptInputWrapper.outerHTML;

      document.querySelector('#Variants-{{ section.id }}').addEventListener('change', function(event) {
        hiddenInput.value = event.currentTarget.value;
      });
    });
  </script>

  {%- liquid
    if product.selected_or_first_available_variant.featured_media
      assign seo_media = product.selected_or_first_available_variant.featured_media
    else
      assign seo_media = product.featured_media
    endif
  -%}

  <script type="application/ld+json">
    {
      "@context": "http://schema.org/",
      "@type": "Product",
      "name": {{ product.title | json }},
      "url": {{ request.origin | append: product.url | json }},
      {% if seo_media -%}
        "image": [
          {{ seo_media | image_url: width: seo_media.preview_image.width | prepend: "https:" | json }}
        ],
      {%- endif %}
      "description": {{ product.description | strip_html | json }},
      {% if product.selected_or_first_available_variant.sku != blank -%}
        "sku": {{ product.selected_or_first_available_variant.sku | json }},
      {%- endif %}
      "brand": {
        "@type": "Brand",
        "name": {{ product.vendor | json }}
      },
      "offers": [
        {%- for variant in product.variants -%}
          {
            "@type" : "Offer",
            {%- if variant.sku != blank -%}
              "sku": {{ variant.sku | json }},
            {%- endif -%}
            {%- if variant.barcode.size == 12 -%}
              "gtin12": {{ variant.barcode }},
            {%- endif -%}
            {%- if variant.barcode.size == 13 -%}
              "gtin13": {{ variant.barcode }},
            {%- endif -%}
            {%- if variant.barcode.size == 14 -%}
              "gtin14": {{ variant.barcode }},
            {%- endif -%}
            "availability" : "http://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}",
            "price" : {{ variant.price | divided_by: 100.00 | json }},
            "priceCurrency" : {{ cart.currency.iso_code | json }},
            "url" : {{ request.origin | append: variant.url | json }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    }
  </script>
</section>

{% schema %}
{
  "name": "t:sections.main-product.name",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "title",
      "name": "t:sections.main-product.blocks.title.name",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "t:sections.main-product.blocks.variant_picker.name",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "t:sections.main-product.blocks.buy_buttons.name",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_dynamic_checkout",
          "default": true,
          "label": "t:sections.main-product.blocks.buy_buttons.settings.show_dynamic_checkout.label",
          "info": "t:sections.main-product.blocks.buy_buttons.settings.show_dynamic_checkout.info"
        }
      ]
    },
    {
      "type": "description",
      "name": "t:sections.main-product.blocks.description.name",
      "limit": 1
    },
    {
      "type": "custom_liquid",
      "name": "t:sections.main-product.blocks.custom_liquid.name",
      "settings": [
        {
          "type": "liquid",
          "id": "custom_liquid",
          "label": "t:sections.main-product.blocks.custom_liquid.settings.custom_liquid.label",
          "info": "t:sections.main-product.blocks.custom_liquid.settings.custom_liquid.info"
        }
      ]
    },
    {
      "type": "accordion",
      "name": "Accordion",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        },
        {
          "type": "page",
          "id": "content_page",
          "label": "Page"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Notification"
    },
    {
      "type": "text",
      "id": "notification_heading",
      "label": "Heading",
      "default": "Lorem ipsum"
    },
    {
      "type": "richtext",
      "id": "notification_content",
      "label": "Content"
    },
    {
      "type": "text",
      "id": "notification_btn",
      "label": "Button label",
      "default": "Notify when available"
    }
  ]
}
{% endschema %}
