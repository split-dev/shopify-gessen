<div class="mt-1 mb-1">
  <div class="container">
    <div class="row row--sm overflow-hidden" data-mansory-grid>
      {% for block in section.blocks %}
        <div class="col-12 col-md-6 col-lg-3{% if block.settings.hide_on_mobile %} d-none d-md-block{% endif %}" data-mansory-grid-item data-item-wrapper>
          {%- assign image = block.settings.image -%}

          {%- capture cycle_content -%}
          {% cycle '0.656', '0.7961165', '0.5974499', '0.53947368', '0.7387387', '0.54214876', '0.61654135', '0.76995305', '0.51330203', '0.67213114', '0.67908902', '0.71929824', '0.656', '0.87234042', '0.754023', '0.56747404' %}
          {%- endcapture -%}

          {%- if section.settings.gallery_layout == 'fixed' -%}
            {%- assign ratio = cycle_content -%}
          {%- else -%}
            {%- assign ratio = image.aspect_ratio -%}
          {%- endif -%}

          {% if image != blank %}
            <div data-aos>
              <div class="border position-relative overflow-hidden" style="padding-bottom: {{ 1 | divided_by: ratio | times: 100 }}%;">
                <img srcset="{%- if image.width >= 165 -%}{{ image | image_url: width: 165 }} 165w,{%- endif -%}
                  {%- if image.width >= 360 -%}{{ image | image_url: width: 360 }} 360w,{%- endif -%}
                  {%- if image.width >= 533 -%}{{ image | image_url: width: 533 }} 533w,{%- endif -%}
                  {%- if image.width >= 720 -%}{{ image | image_url: width: 720 }} 720w,{%- endif -%}
                  {%- if image.width >= 940 -%}{{ image | image_url: width: 940 }} 940w,{%- endif -%}
                  {%- if image.width >= 1066 -%}{{ image | image_url: width: 1066 }} 1066w,{%- endif -%}
                  {{ image | image_url }} {{ image.width }}w"
                     sizes="(min-width: 991px) calc((100vw - 2rem) / 3), calc(100vw - 2rem)"
                     src="{{ image | image_url: width: 533 }}"
                     class="absolute-fill w-100 h-100 fit-cover motion-reduce"
                     loading="lazy"
                     width="100"
                     height="100"
                     alt="{{ image.alt }}">
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const selector = document.querySelector('#shopify-section-{{ section.id }} [data-mansory-grid]');

    new Masonry(selector, {
      itemSelector: '[data-mansory-grid-item]'
    });

    masonry.on('layoutComplete', AOS.refreshHard)

    // document.addEventListener('shopify:section:load', () => {
    //   masonry.reloadItems()
    // });
  });
</script>

{% schema %}
{
  "name": "Gallery",
  "settings": [
    {
      "type": "select",
      "id": "gallery_layout",
      "options": [
        {"value": "fixed", "label": "Fixed"},
        {"value": "masonry", "label": "Masonry"}
      ],
      "default": "fixed",
      "label": "Layout"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "checkbox",
          "id": "hide_on_mobile",
          "label": "Hide on mobile"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Gallery"
    }
  ]
}
{% endschema %}